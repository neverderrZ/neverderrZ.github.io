<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, sans-serif;
  background: linear-gradient(135deg, #fde2e4, #e4c1f9);
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}
.card {
  background: #fff;
  border-radius: 24px;
  padding: 24px;
  width: 320px;
  text-align: center;
  box-shadow: 0 10px 30px rgba(0,0,0,.15);
}
h2 { margin: 0; color: #5f4b8b; }
#content { margin-top: 20px; }
.board {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
}
.cell {
  height: 80px;
  border-radius: 16px;
  background: #f7f7f7;
  font-size: 36px;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  user-select: none;
}
.result {
  font-size: 18px;
  font-weight: 500;
  color: #444;
  margin: 40px 0;
}
button {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 16px;
  background: #e5989b;
  color: #fff;
  font-size: 16px;
  cursor: pointer;
  margin-top: 16px;
}
</style>
</head>

<body>
<div class="card">
  <h2>üå∏ –ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏</h2>
  <div id="content"></div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const EMPTY = "";
const PLAYER = "‚ùå";
const BOT = "‚≠ï";
const AI_MISTAKE_CHANCE = 0.35;

let board;
let gameOver = false;

const contentEl = document.getElementById("content");

function startGame() {
  board = Array(9).fill(EMPTY);
  gameOver = false;
  renderBoard();
}

function renderBoard() {
  contentEl.innerHTML = `<div class="board" id="board"></div>`;
  const boardEl = document.getElementById("board");
  board.forEach((v, i) => {
    const cell = document.createElement("div");
    cell.className = "cell";
    cell.textContent = v;
    if (!gameOver && v === EMPTY) cell.onclick = () => move(i);
    boardEl.appendChild(cell);
  });
}

function renderResult(text, payload) {
  contentEl.innerHTML = `
    <div class="result">${text}</div>
    <button onclick="startGame()">üîÅ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
  `;
  tg.sendData(payload);
}

function checkWin(sym) {
  const wins = [
    [0,1,2],[3,4,5],[6,7,8],
    [0,3,6],[1,4,7],[2,5,8],
    [0,4,8],[2,4,6]
  ];
  return wins.some(line => line.every(i => board[i] === sym));
}

function smartMove() {
  const lines = [
    [0,1,2],[3,4,5],[6,7,8],
    [0,3,6],[1,4,7],[2,5,8],
    [0,4,8],[2,4,6]
  ];
  for (let sym of [BOT, PLAYER]) {
    for (let line of lines) {
      const vals = line.map(i => board[i]);
      if (vals.filter(v => v === sym).length === 2 && vals.includes(EMPTY)) {
        return line[vals.indexOf(EMPTY)];
      }
    }
  }
  if (board[4] === EMPTY) return 4;
  const corners = [0,2,6,8].filter(i => board[i] === EMPTY);
  if (corners.length) return corners[Math.floor(Math.random() * corners.length)];
  return board.findIndex(c => c === EMPTY);
}

function dumbMove() {
  const free = board.map((v,i)=>v===EMPTY?i:null).filter(i=>i!==null);
  return free.length ? free[Math.floor(Math.random()*free.length)] : -1;
}

function move(i) {
  if (gameOver || board[i] !== EMPTY) return;
  board[i] = PLAYER;
  renderBoard();
  if (checkWin(PLAYER)) {
    gameOver = true;
    const promo = Math.floor(10000 + Math.random()*90000);
    return renderResult(`üéâ –ü–æ–±–µ–¥–∞!<br>–ü—Ä–æ–º–æ–∫–æ–¥: <b>${promo}</b>`, `win:${promo}`);
  }
  if (!board.includes(EMPTY)) {
    gameOver = true;
    return renderResult("ü§ç –ù–∏—á—å—è", "draw");
  }
  const aiIndex = Math.random() < AI_MISTAKE_CHANCE ? dumbMove() : smartMove();
  if (aiIndex !== -1) board[aiIndex] = BOT;
  renderBoard();
  if (checkWin(BOT)) {
    gameOver = true;
    return renderResult("üòî –ü—Ä–æ–∏–≥—Ä—ã—à", "lose");
  }
  if (!board.includes(EMPTY)) {
    gameOver = true;
    return renderResult("ü§ç –ù–∏—á—å—è", "draw");
  }
}

startGame();
</script>
</body>
</html>
